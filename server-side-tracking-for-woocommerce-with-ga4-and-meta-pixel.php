<?php

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						/**
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Plugin Name: Server-Side Tracking for WooCommerce with GA4 and Meta Pixel
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Plugin URI: https://iodata.work/ga4-facebook-pixel-server-side-tracking-for-woocommerce/
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Description: Sends WooCommerce events (view_item, add_to_cart, remove_from_cart, begin_checkout, purchase, refund) directly to Google Analytics 4 via Measurement Protocol and Meta Pixel via Conversions API.
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Version: 1.2.0
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Author: IO Data
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Author URI: https://iodata.work
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * License: GPL-2.0-or-later
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Text Domain: server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Domain Path: /languages
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Requires Plugins: woocommerce
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Requires at least: 5.0
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Requires PHP: 7.2
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * WC requires at least: 3.0
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * WC tested up to: 8.0
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Copyright (C) 2024 IO Data - https://iodata.work
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Original Author: IO Data
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * This program is free software; you can redistribute it and/or modify
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * it under the terms of the GNU General Public License as published by
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * the Free Software Foundation; either version 2 of the License, or
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * (at your option) any later version.
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * This program is distributed in the hope that it will be useful,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * but WITHOUT ANY WARRANTY; without even the implied warranty of
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * GNU General Public License for more details.
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * You should have received a copy of the GNU General Public License
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * along with this program; if not, write to the Free Software
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * MA 02110-1301, USA.
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * ADDITIONAL TERMS (Under GPL Section 7):
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * 1. Attribution Requirement:
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  If you distribute this plugin or any derivative work, you must retain
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  the following attribution notice in all copies:
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  "Originally created by IO Data (https://iodata.work)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  Original plugin: GA4 Server-Side Tracking for WooCommerce
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  Source: https://github.com/io-woo-invoicer/server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel"
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  This attribution must appear:
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  - In the plugin header of any derivative work
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  - In any documentation or readme files
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  - In any user-facing credits or about sections
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  - Must remain visible and unmodified
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * 2. Naming Restriction:
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  You may not use the name "GA4 Server-Side Tracking for WooCommerce"
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  or "IO Data" in derivative works without written permission, except
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  to acknowledge the original creation as required above.
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * 3. No Warranty Claims:
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  You may not claim warranty or support from the original author for
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *  any modifications or derivative works you create.
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 *
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * These additional terms are compatible with the GPL v2 license and do not
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * restrict any rights granted under the GPL. They only add attribution
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 * requirements as permitted under Section 7 of the GPL.
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						 */

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						if (! defined('ABSPATH')) exit; // Exit if accessed directly

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						class GA4_S2S_Woo_Tracking
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						{

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private $options_name = 'ga4_s2s_tracking_options';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private $log_post_type = 'ga4_s2s_log';

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function __construct()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								register_activation_hook(__FILE__, [$this, 'activate']);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Register custom post type for logs
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								add_action('init', [$this, 'register_log_post_type']);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Declare HPOS compatibility
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								add_action('before_woocommerce_init', [$this, 'declare_hpos_compatibility']);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								add_action('admin_menu', [$this, 'add_admin_menu']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								add_action('admin_init', [$this, 'settings_init']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								add_action('admin_enqueue_scripts', [$this, 'enqueue_admin_scripts']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								add_action('wp_ajax_ga4_s2s_clear_logs', [$this, 'ajax_clear_logs']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								add_action('wp_ajax_ga4_s2s_delete_logs', [$this, 'ajax_delete_logs']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								add_action('wp_ajax_ga4_s2s_get_logs', [$this, 'ajax_get_logs']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								add_action('wp_ajax_ga4_s2s_send_test_event', [$this, 'ajax_send_test_event']);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->init_tracking_hooks();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function declare_hpos_compatibility()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (class_exists('\Automattic\WooCommerce\Utilities\FeaturesUtil')) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									\Automattic\WooCommerce\Utilities\FeaturesUtil::declare_compatibility('custom_order_tables', __FILE__, true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function activate()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Flush rewrite rules for custom post type
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->register_log_post_type();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								flush_rewrite_rules();

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$default_options = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'measurement_id' => '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'api_secret' => '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'fb_pixel_id' => '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'fb_access_token' => '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'fb_test_event_code' => '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'enable_ga4' => '1',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'enable_facebook' => '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'enabled_events' => [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'view_item' => '1',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'view_cart' => '1',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'add_to_cart' => '1',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'remove_from_cart' => '1',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'begin_checkout' => '1',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'add_shipping_info' => '1',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'add_payment_info' => '1',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'purchase' => '1',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'payment_failed' => '1',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'refund' => '1'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'enable_logging' => '1',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'debug_mode' => '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'override_currency' => '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'target_currency' => 'USD',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'exchange_rate' => '1.0'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!get_option($this->options_name)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									update_option($this->options_name, $default_options);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function register_log_post_type()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$args = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'label' => 'GA4 Event Logs',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'public' => false,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'publicly_queryable' => false,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'show_ui' => false,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'show_in_menu' => false,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'query_var' => false,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'rewrite' => false,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'capability_type' => 'post',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'has_archive' => false,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'hierarchical' => false,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'supports' => ['title', 'editor', 'custom-fields'],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'show_in_rest' => false,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'exclude_from_search' => true,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								register_post_type($this->log_post_type, $args);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private function init_tracking_hooks()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$options = get_option($this->options_name, []);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$enabled_events = isset($options['enabled_events']) ? $options['enabled_events'] : [];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($enabled_events['view_item'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('woocommerce_after_single_product', [$this, 'track_view_item']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($enabled_events['view_cart'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('woocommerce_before_cart', [$this, 'track_view_cart']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($enabled_events['add_to_cart'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('woocommerce_add_to_cart', [$this, 'track_add_to_cart'], 10, 6);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($enabled_events['remove_from_cart'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('woocommerce_remove_cart_item', [$this, 'track_remove_from_cart'], 10, 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($enabled_events['begin_checkout'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('woocommerce_checkout_init', [$this, 'track_begin_checkout']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($enabled_events['add_shipping_info'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('woocommerce_checkout_update_order_review', [$this, 'track_add_shipping_info']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('wp_ajax_track_shipping_method', [$this, 'ajax_track_shipping_method']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('wp_ajax_nopriv_track_shipping_method', [$this, 'ajax_track_shipping_method']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (!empty($enabled_events['add_payment_info'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										add_action('wp_enqueue_scripts', [$this, 'enqueue_checkout_tracking_script']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($enabled_events['add_payment_info'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('woocommerce_after_checkout_validation', [$this, 'track_add_payment_info'], 10, 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('wp_ajax_track_payment_method', [$this, 'ajax_track_payment_method']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('wp_ajax_nopriv_track_payment_method', [$this, 'ajax_track_payment_method']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (empty($enabled_events['add_shipping_info'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										add_action('wp_enqueue_scripts', [$this, 'enqueue_checkout_tracking_script']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($enabled_events['purchase'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('woocommerce_thankyou', [$this, 'track_purchase']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($enabled_events['payment_failed'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('woocommerce_order_status_failed', [$this, 'track_payment_failed']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('woocommerce_payment_failed', [$this, 'track_payment_failed_checkout']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($enabled_events['refund'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									add_action('woocommerce_order_fully_refunded', [$this, 'track_refund']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function add_admin_menu()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								add_menu_page(
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									__('GA4 S2S Tracking', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									__('GA4 Tracking', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'manage_options',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									[$this, 'admin_page'],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'dashicons-analytics',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									30
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								add_submenu_page(
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									__('Settings', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									__('Settings', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'manage_options',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									[$this, 'admin_page']
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								add_submenu_page(
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									__('Event Logs', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									__('Event Logs', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'manage_options',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel-logs',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									[$this, 'logs_page']
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function settings_init()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Completely skip registering settings to avoid any interference
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// We handle all saving directly in admin_page()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								return;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function enqueue_admin_scripts($hook)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Only load on our admin pages
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									strpos($hook, 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel') === false &&
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									strpos($hook, 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel-logs') === false
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									return;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								wp_enqueue_script(
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'ga4-s2s-admin',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									plugin_dir_url(__FILE__) . 'assets/admin.js',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									array('jquery'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'1.2.0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									true
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Localize script with necessary data
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								wp_localize_script('ga4-s2s-admin', 'ga4_s2s_admin', array(
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'ajaxurl' => admin_url('admin-ajax.php'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'test_nonce' => wp_create_nonce('ga4_s2s_test'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'clear_logs_nonce' => wp_create_nonce('ga4_s2s_logs'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'delete_logs_nonce' => wp_create_nonce('ga4_s2s_logs'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'sending_text' => __('Sending...', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'send_test_text' => __('Send Test Event', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'test_success' => __('Test event sent successfully! Check the Event Logs to see the response.', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'test_error' => __('Error sending test event: ', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'confirm_clear_logs' => __('Are you sure you want to clear all event logs?', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'clear_logs_error' => __('Error clearing logs', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel')
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function sanitize_settings($input)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$sanitized = [];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Sanitize measurement ID
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($input['measurement_id'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$sanitized['measurement_id'] = sanitize_text_field($input['measurement_id']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Sanitize API secret
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($input['api_secret'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$sanitized['api_secret'] = sanitize_text_field($input['api_secret']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Sanitize Facebook Pixel settings
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($input['fb_pixel_id'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$sanitized['fb_pixel_id'] = sanitize_text_field($input['fb_pixel_id']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($input['fb_access_token'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$sanitized['fb_access_token'] = sanitize_text_field($input['fb_access_token']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($input['fb_test_event_code'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$sanitized['fb_test_event_code'] = sanitize_text_field($input['fb_test_event_code']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Sanitize checkboxes
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$sanitized['enable_ga4'] = isset($input['enable_ga4']) ? '1' : '0';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$sanitized['enable_facebook'] = isset($input['enable_facebook']) ? '1' : '0';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$sanitized['enable_logging'] = isset($input['enable_logging']) ? '1' : '0';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$sanitized['debug_mode'] = isset($input['debug_mode']) ? '1' : '0';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$sanitized['override_currency'] = isset($input['override_currency']) ? '1' : '0';

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Sanitize currency settings
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($input['target_currency'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$valid_currencies = ['USD', 'EUR', 'GBP', 'JPY', 'AUD', 'CAD'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$sanitized['target_currency'] = in_array($input['target_currency'], $valid_currencies)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										? $input['target_currency']
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										: 'USD';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($input['exchange_rate'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$sanitized['exchange_rate'] = floatval($input['exchange_rate']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									// Ensure exchange rate is positive
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if ($sanitized['exchange_rate'] <= 0) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$sanitized['exchange_rate'] = 1.0;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Sanitize enabled events
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($input['enabled_events']) && is_array($input['enabled_events'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$sanitized['enabled_events'] = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$valid_events = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'view_item',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'view_cart',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'add_to_cart',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'remove_from_cart',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'begin_checkout',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'add_shipping_info',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'add_payment_info',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'purchase',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'payment_failed',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'refund'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									foreach ($valid_events as $event) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$sanitized['enabled_events'][$event] = isset($input['enabled_events'][$event]) ? '1' : '0';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								return $sanitized;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function admin_page()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Check if user has permission to access this page
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!current_user_can('manage_options')) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_die(esc_html__('You do not have sufficient permissions to access this page.', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($_POST['submit']) && isset($_POST['ga4_s2s_nonce']) && wp_verify_nonce(sanitize_text_field(wp_unslash($_POST['ga4_s2s_nonce'])), 'ga4_s2s_settings')) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									// Process form submission
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options['measurement_id'] = isset($_POST['measurement_id']) ? sanitize_text_field(wp_unslash($_POST['measurement_id'])) : '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options['api_secret'] = isset($_POST['api_secret']) ? sanitize_text_field(wp_unslash($_POST['api_secret'])) : '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options['fb_pixel_id'] = isset($_POST['fb_pixel_id']) ? sanitize_text_field(wp_unslash($_POST['fb_pixel_id'])) : '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options['fb_access_token'] = isset($_POST['fb_access_token']) ? sanitize_text_field(wp_unslash($_POST['fb_access_token'])) : '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options['fb_test_event_code'] = isset($_POST['fb_test_event_code']) ? sanitize_text_field(wp_unslash($_POST['fb_test_event_code'])) : '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									// Handle checkboxes - unchecked checkboxes don't send any data
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									// Since we're inside the form submission block, we know the form was submitted
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									// If checkbox is not in POST data, it was unchecked
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options['enable_ga4'] = isset($_POST['enable_ga4']) ? '1' : '0';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options['enable_facebook'] = isset($_POST['enable_facebook']) ? '1' : '0';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options['enable_logging'] = isset($_POST['enable_logging']) ? '1' : '0';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options['debug_mode'] = isset($_POST['debug_mode']) ? '1' : '0';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options['override_currency'] = isset($_POST['override_currency']) ? '1' : '0';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options['target_currency'] = isset($_POST['target_currency']) ? sanitize_text_field(wp_unslash($_POST['target_currency'])) : 'USD';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options['exchange_rate'] = isset($_POST['exchange_rate']) ? floatval($_POST['exchange_rate']) : 1.0;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options['enabled_events'] = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'view_item' => isset($_POST['track_view_item']) ? '1' : '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'view_cart' => isset($_POST['track_view_cart']) ? '1' : '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'add_to_cart' => isset($_POST['track_add_to_cart']) ? '1' : '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'remove_from_cart' => isset($_POST['track_remove_from_cart']) ? '1' : '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'begin_checkout' => isset($_POST['track_begin_checkout']) ? '1' : '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'add_shipping_info' => isset($_POST['track_add_shipping_info']) ? '1' : '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'add_payment_info' => isset($_POST['track_add_payment_info']) ? '1' : '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'purchase' => isset($_POST['track_purchase']) ? '1' : '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'payment_failed' => isset($_POST['track_payment_failed']) ? '1' : '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'refund' => isset($_POST['track_refund']) ? '1' : '0'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									// Use WordPress option functions with caching
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$cache_key = 'ga4_s2s_' . $this->options_name;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									// Update the option using WordPress function
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									update_option($this->options_name, $options, 'yes');

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									// Clear the cache
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_cache_delete($cache_key, 'ga4_s2s_options');
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_cache_delete($this->options_name, 'options');

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									echo '<div class="notice notice-success"><p>' . esc_html__('Settings saved successfully!', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel') . '</p></div>';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get the current options with caching
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$cache_key = 'ga4_s2s_' . $this->options_name;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$options = wp_cache_get($cache_key, 'ga4_s2s_options');

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (false === $options) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options = get_option($this->options_name, []);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_cache_set($cache_key, $options, 'ga4_s2s_options', 3600); // Cache for 1 hour
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// If no options exist, use defaults
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (empty($options)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$options = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'measurement_id' => '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'api_secret' => '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'fb_pixel_id' => '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'fb_access_token' => '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'fb_test_event_code' => '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'enable_ga4' => '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'enable_facebook' => '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'enabled_events' => [],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'enable_logging' => '1',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'debug_mode' => '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'override_currency' => '0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'target_currency' => 'USD',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'exchange_rate' => '1.0'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}


																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						?>
<div class="wrap">
	<h1><?php echo esc_html__('GA4 & Facebook Pixel Server-Side Tracking Settings', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></h1>

	<form method="post" action="">
		<?php wp_nonce_field('ga4_s2s_settings', 'ga4_s2s_nonce'); ?>

		<h2><?php echo esc_html__('Platform Selection', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></h2>
		<table class="form-table">
			<tr>
				<th scope="row"><?php echo esc_html__('Enable Platforms', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></th>
				<td>
					<!-- Hidden fields to track form submission -->
					<input type="hidden" name="platform_settings_submitted" value="1" />

					<label style="margin-right: 20px;">
						<input type="checkbox" name="enable_ga4" value="1"
							<?php checked(isset($options['enable_ga4']) && $options['enable_ga4'] === '1'); ?> />
						<?php echo esc_html__('Google Analytics 4', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?>
					</label>
					<label>
						<input type="checkbox" name="enable_facebook" value="1"
							<?php checked(isset($options['enable_facebook']) && $options['enable_facebook'] === '1'); ?> />
						<?php echo esc_html__('Facebook Pixel', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?>
					</label>
				</td>
			</tr>
		</table>

		<div id="ga4-configuration-section" style="<?php echo (!isset($options['enable_ga4']) || $options['enable_ga4'] !== '1') ? 'display:none;' : ''; ?>">
			<h2><?php echo esc_html__('Google Analytics 4 Configuration', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></h2>

			<table class="form-table">
				<tr>
					<th scope="row"><label for="measurement_id"><?php echo esc_html__('Measurement ID', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></label></th>
					<td>
						<input type="text" id="measurement_id" name="measurement_id"
							value="<?php echo esc_attr($options['measurement_id'] ?? ''); ?>"
							class="regular-text" placeholder="G-XXXXXXXXXX" />
						<p class="description">
							<?php echo esc_html__('Your GA4 Measurement ID (e.g., G-XXXXXXXXXX)', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?><br>
							<a href="https://support.google.com/analytics/answer/12270356#measurement_id" target="_blank">
								<?php echo esc_html__('Where to find Measurement ID', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?> 
							</a>
						</p>
					</td>
				</tr>
				<tr>
					<th scope="row"><label for="api_secret"><?php echo esc_html__('API Secret', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></label></th>
					<td>
						<input type="password" id="api_secret" name="api_secret"
							value="<?php echo esc_attr($options['api_secret'] ?? ''); ?>"
							class="regular-text" />
						<button type="button" class="button button-secondary" id="toggle-api-secret" style="margin-left: 5px;">
							<?php echo esc_html__('Show/Hide', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?>
						</button>
						<p class="description">
							<?php echo esc_html__('Your GA4 Measurement Protocol API Secret', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?><br>
							<a href="https://support.google.com/analytics/answer/12270356#api_secret" target="_blank">
								<?php echo esc_html__('How to create API Secret', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?> 
							</a>
						</p>
					</td>
				</tr>
				<tr>
					<th scope="row"></th>
					<td>
						<div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-top: 10px;">
							<p style="margin: 0 0 10px 0; color: #666;">
								<strong><?php echo esc_html__('How to get your GA4 credentials:', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></strong>
							</p>
							<ol style="margin: 0 0 10px 0; padding-left: 20px; color: #666;">
								<li><?php echo esc_html__('Go to your Google Analytics 4 property', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></li>
								<li><?php echo esc_html__('Navigate to Admin (gear icon)  Data Streams', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></li>
								<li><?php echo esc_html__('Select your web data stream', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></li>
								<li><?php echo esc_html__('Copy the Measurement ID (starts with G-)', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></li>
								<li><?php echo esc_html__('Scroll down to "Measurement Protocol API secrets"', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></li>
								<li><?php echo esc_html__('Click "Create" to generate a new API secret', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></li>
								<li><?php echo esc_html__('Copy the generated API secret', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></li>
							</ol>
							<p style="margin: 0; color: #666;">
								<a href="https://developers.google.com/analytics/devguides/collection/protocol/ga4/sending-events" target="_blank" style="text-decoration: none;">
									<?php echo esc_html__('View Google Documentation', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?> 
								</a> |
								<a href="https://support.google.com/analytics/answer/12270356" target="_blank" style="text-decoration: none;">
									<?php echo esc_html__('GA4 Measurement Protocol Guide', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?> 
								</a>
							</p>
						</div>
					</td>
				</tr>
			</table>
		</div>

		<div id="facebook-configuration-section" style="<?php echo (!isset($options['enable_facebook']) || $options['enable_facebook'] !== '1') ? 'display:none;' : ''; ?>">
			<h2><?php echo esc_html__('Facebook Pixel Configuration', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></h2>

			<table class="form-table">
				<tr>
					<th scope="row"><label for="fb_pixel_id"><?php echo esc_html__('Pixel ID', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></label></th>
					<td>
						<input type="text" id="fb_pixel_id" name="fb_pixel_id"
							value="<?php echo esc_attr($options['fb_pixel_id'] ?? ''); ?>"
							class="regular-text" placeholder="1234567890123456" />
						<p class="description">
							<?php echo esc_html__('Your Facebook Pixel ID (16 digits)', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?><br>
							<a href="https://www.facebook.com/business/help/952192354843755" target="_blank">
								<?php echo esc_html__('Where to find Pixel ID', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?> 
							</a>
						</p>
					</td>
				</tr>
				<tr>
					<th scope="row"><label for="fb_access_token"><?php echo esc_html__('Access Token', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></label></th>
					<td>
						<input type="password" id="fb_access_token" name="fb_access_token"
							value="<?php echo esc_attr($options['fb_access_token'] ?? ''); ?>"
							class="regular-text" />
						<button type="button" class="button button-secondary" id="toggle-fb-token" style="margin-left: 5px;">
							<?php echo esc_html__('Show/Hide', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?>
						</button>
						<p class="description">
							<?php echo esc_html__('Your Facebook Conversions API Access Token', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?><br>
							<a href="https://developers.facebook.com/docs/marketing-api/conversions-api/get-started#access-token" target="_blank">
								<?php echo esc_html__('How to generate Access Token', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?> 
							</a>
						</p>
					</td>
				</tr>
				<tr>
					<th scope="row"><label for="fb_test_event_code"><?php echo esc_html__('Test Event Code', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></label></th>
					<td>
						<input type="text" id="fb_test_event_code" name="fb_test_event_code"
							value="<?php echo esc_attr($options['fb_test_event_code'] ?? ''); ?>"
							class="regular-text" placeholder="TEST12345 (optional)" />
						<p class="description">
							<?php echo esc_html__('Optional: Test event code from Facebook Events Manager for debugging', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?>
						</p>
					</td>
				</tr>
				<tr>
					<th scope="row"></th>
					<td>
						<div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-top: 10px;">
							<p style="margin: 0 0 10px 0; color: #666;">
								<strong><?php echo esc_html__('How to get your Facebook Pixel credentials:', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></strong>
							</p>
							<ol style="margin: 0 0 10px 0; padding-left: 20px; color: #666;">
								<li><?php echo esc_html__('Go to Facebook Events Manager', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></li>
								<li><?php echo esc_html__('Select your Pixel or create a new one', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></li>
								<li><?php echo esc_html__('Copy the Pixel ID from Settings', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></li>
								<li><?php echo esc_html__('Navigate to Settings  Conversions API', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></li>
								<li><?php echo esc_html__('Generate an Access Token', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></li>
								<li><?php echo esc_html__('(Optional) Enable Test Events and get Test Event Code', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></li>
							</ol>
							<p style="margin: 0; color: #666;">
								<a href="https://developers.facebook.com/docs/marketing-api/conversions-api/get-started" target="_blank" style="text-decoration: none;">
									<?php echo esc_html__('View Facebook Documentation', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?> 
								</a>
							</p>
						</div>
					</td>
				</tr>
			</table>
		</div>

		<h2><?php echo esc_html__('Currency Settings', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></h2>
		<table class="form-table">
			<tr>
				<th scope="row">Current Store Currency</th>
				<td>
					<strong><?php echo esc_html(get_woocommerce_currency()); ?></strong>
					<?php
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$current_symbol = get_woocommerce_currency_symbol();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($current_symbol) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									echo esc_html(" ($current_symbol)");
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
					?>
				</td>
			</tr>
			<tr>
				<th scope="row">Override Currency</th>
				<td>
					<label>
						<input type="checkbox" name="override_currency" id="override_currency" value="1"
							<?php checked(!empty($options['override_currency'])); ?> />
						Convert prices to a different currency for GA4
					</label>
					<p class="description">Enable this if your store uses a currency that GA4 doesn't support well (non-EUR/USD)</p>
				</td>
			</tr>
			<tr class="currency-override-settings" style="<?php echo empty($options['override_currency']) ? 'display:none;' : ''; ?>">
				<th scope="row"><label for="target_currency">Target Currency</label></th>
				<td>
					<select name="target_currency" id="target_currency">
						<option value="USD" <?php selected($options['target_currency'] ?? 'USD', 'USD'); ?>>USD - US Dollar</option>
						<option value="EUR" <?php selected($options['target_currency'] ?? 'USD', 'EUR'); ?>>EUR - Euro</option>
						<option value="GBP" <?php selected($options['target_currency'] ?? 'USD', 'GBP'); ?>>GBP - British Pound</option>
						<option value="JPY" <?php selected($options['target_currency'] ?? 'USD', 'JPY'); ?>>JPY - Japanese Yen</option>
						<option value="AUD" <?php selected($options['target_currency'] ?? 'USD', 'AUD'); ?>>AUD - Australian Dollar</option>
						<option value="CAD" <?php selected($options['target_currency'] ?? 'USD', 'CAD'); ?>>CAD - Canadian Dollar</option>
					</select>
					<p class="description">Currency that will be sent to GA4</p>
				</td>
			</tr>
			<tr class="currency-override-settings" style="<?php echo empty($options['override_currency']) ? 'display:none;' : ''; ?>">
				<th scope="row"><label for="exchange_rate">Exchange Rate</label></th>
				<td>
					<input type="number" id="exchange_rate" name="exchange_rate"
						value="<?php echo esc_attr($options['exchange_rate'] ?? '1.0'); ?>"
						step="0.0001" min="0.0001" class="regular-text" />
					<p class="description">
						1 <?php echo esc_html(get_woocommerce_currency()); ?> = <span id="exchange-preview"><?php echo esc_html($options['exchange_rate'] ?? '1.0'); ?></span> <span id="target-currency-preview"><?php echo esc_html($options['target_currency'] ?? 'USD'); ?></span><br>
						<?php
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								/* translators: %s: Current store currency code */
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								printf(esc_html__('Example: If 1 %s = 1.2 USD, enter 1.2', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'), esc_html(get_woocommerce_currency()));
						?>
					</p>
				</td>
			</tr>
		</table>

		<h2><?php echo esc_html__('Event Tracking Settings', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></h2>
		<p>Select which WooCommerce events to track:</p>
		<table class="form-table">
			<tr>
				<th scope="row">Events to Track</th>
				<td>
					<fieldset>
						<label>
							<input type="checkbox" name="track_view_item" value="1"
								<?php checked(!empty($options['enabled_events']['view_item'])); ?> />
							View Item (Product page views)
						</label><br>

						<label>
							<input type="checkbox" name="track_view_cart" value="1"
								<?php checked(!empty($options['enabled_events']['view_cart'])); ?> />
							View Cart (Cart page views)
						</label><br>

						<label>
							<input type="checkbox" name="track_add_to_cart" value="1"
								<?php checked(!empty($options['enabled_events']['add_to_cart'])); ?> />
							Add to Cart
						</label><br>

						<label>
							<input type="checkbox" name="track_remove_from_cart" value="1"
								<?php checked(!empty($options['enabled_events']['remove_from_cart'])); ?> />
							Remove from Cart
						</label><br>

						<label>
							<input type="checkbox" name="track_begin_checkout" value="1"
								<?php checked(!empty($options['enabled_events']['begin_checkout'])); ?> />
							Begin Checkout
						</label><br>

						<label>
							<input type="checkbox" name="track_add_shipping_info" value="1"
								<?php checked(!empty($options['enabled_events']['add_shipping_info'])); ?> />
							Add Shipping Info (Shipping method selection)
						</label><br>

						<label>
							<input type="checkbox" name="track_add_payment_info" value="1"
								<?php checked(!empty($options['enabled_events']['add_payment_info'])); ?> />
							Add Payment Info (Payment method selection)
						</label><br>

						<label>
							<input type="checkbox" name="track_purchase" value="1"
								<?php checked(!empty($options['enabled_events']['purchase'])); ?> />
							Purchase (Order completion)
						</label><br>

						<label>
							<input type="checkbox" name="track_payment_failed" value="1"
								<?php checked(!empty($options['enabled_events']['payment_failed'])); ?> />
							Payment Failed
						</label><br>

						<label>
							<input type="checkbox" name="track_refund" value="1"
								<?php checked(!empty($options['enabled_events']['refund'])); ?> />
							Refund
						</label>
					</fieldset>
				</td>
			</tr>
		</table>

		<h2><?php echo esc_html__('Logging & Debug Settings', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></h2>
		<table class="form-table">
			<tr>
				<th scope="row">Enable Logging</th>
				<td>
					<label>
						<input type="checkbox" name="enable_logging" value="1"
							<?php checked(!empty($options['enable_logging'])); ?> />
						Log all fired events for debugging
					</label>
					<p class="description"><?php echo esc_html__('Enable this to track all events sent to GA4 in the Event Logs', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></p>
				</td>
			</tr>
			<tr>
				<th scope="row">Debug Mode</th>
				<td>
					<label>
						<input type="checkbox" name="debug_mode" value="1"
							<?php checked(!empty($options['debug_mode'])); ?> />
						Enable verbose debug logging
					</label>
					<p class="description">Shows detailed information including full payloads, headers, and responses. Also enables test event button.</p>
				</td>
			</tr>
		</table>

		<?php if (!empty($options['debug_mode'])): ?>
			<h2>Debug Tools</h2>
			<table class="form-table">
				<tr>
					<th scope="row">Send Test Event</th>
					<td>
						<select id="test-platform" style="margin-right: 10px;">
							<option value="both">Both Platforms</option>
							<option value="ga4">GA4 Only</option>
							<option value="facebook">Facebook Only</option>
						</select>
						<button type="button" id="send-test-event" class="button">Send Test Event</button>
						<span id="test-event-result" style="margin-left: 10px;"></span>
						<p class="description">Sends a test event to verify your configuration is working</p>
					</td>
				</tr>
				<tr>
					<th scope="row">Connection Status</th>
					<td>
						<div id="connection-status">
							<div>
								GA4:
								<?php if (isset($options['enable_ga4']) && $options['enable_ga4'] === '1' && $options['measurement_id'] && $options['api_secret']): ?>
									<span style="color: green;"> Configured</span>
								<?php elseif (isset($options['enable_ga4']) && $options['enable_ga4'] === '1'): ?>
									<span style="color: red;"> Missing credentials</span>
								<?php else: ?>
									<span style="color: gray;">Disabled</span>
								<?php endif; ?>
							</div>
							<div>
								Facebook:
								<?php if (isset($options['enable_facebook']) && $options['enable_facebook'] === '1' && $options['fb_pixel_id'] && $options['fb_access_token']): ?>
									<span style="color: green;"> Configured</span>
								<?php elseif (isset($options['enable_facebook']) && $options['enable_facebook'] === '1'): ?>
									<span style="color: red;"> Missing credentials</span>
								<?php else: ?>
									<span style="color: gray;">Disabled</span>
								<?php endif; ?>
							</div>
						</div>
					</td>
				</tr>
			</table>
		<?php endif; ?>

		<?php submit_button(__('Save Settings', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel')); ?>
	</form>

	<hr style="margin-top: 50px;">
	<p style="text-align: center; color: #666; font-size: 12px; margin-top: 20px;">
		<?php echo wp_kses_post(sprintf(
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									/* translators: 1: Plugin version, 2: Author name */
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									esc_html__('GA4 Server-Side Tracking for WooCommerce v%1$s | Created by %2$s', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'1.1.0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'<a href="https://iodata.work" target="_blank" style="text-decoration: none;">IO Data</a>'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								)); ?>

	</p>
</div>
<?php
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function logs_page()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Check if user has permission to access this page
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!current_user_can('manage_options')) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_die(esc_html__('You do not have sufficient permissions to access this page.', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$options = get_option($this->options_name, []);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$is_debug = !empty($options['debug_mode']);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get current page number using WordPress query var
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$page = get_query_var('paged') ? absint(get_query_var('paged')) : 1;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$per_page = 50;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Query logs using WP_Query
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$count_args = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'post_type' => $this->log_post_type,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'post_status' => 'private',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'posts_per_page' => -1,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'fields' => 'ids'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$count_query = new WP_Query($count_args);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$total_items = $count_query->found_posts;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$total_pages = ceil($total_items / $per_page);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get paginated logs
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$args = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'post_type' => $this->log_post_type,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'post_status' => 'private',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'posts_per_page' => $per_page,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'paged' => $page,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'orderby' => 'date',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'order' => 'DESC'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$logs_query = new WP_Query($args);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$logs = [];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Format logs for display
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($logs_query->have_posts()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									while ($logs_query->have_posts()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$logs_query->the_post();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$post_id = get_the_ID();

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log = new stdClass();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->id = $post_id;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->timestamp = get_post_meta($post_id, '_ga4_timestamp', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->event_name = get_post_meta($post_id, '_ga4_event_name', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->event_params = get_post_meta($post_id, '_ga4_event_params', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->response_code = get_post_meta($post_id, '_ga4_response_code', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->response_body = get_post_meta($post_id, '_ga4_response_body', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->debug_info = get_post_meta($post_id, '_ga4_debug_info', true);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$logs[] = $log;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_reset_postdata();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

?>
	<div class="wrap">
		<h1><?php echo esc_html__('GA4 Event Logs', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></h1>

		<div style="margin: 20px 0;">
			<button class="button" id="refresh-logs">Refresh Logs</button>
			<button class="button" id="delete-selected" style="margin-left: 10px;">Delete Selected</button>
			<button class="button" id="clear-logs" style="margin-left: 10px;">Clear All Logs</button>
			<span id="log-status" style="margin-left: 15px;"></span>
		</div>

		<?php if ($total_items > 0): ?>
			<p><?php echo esc_html__('Total events logged:', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?> <strong><?php echo esc_html(number_format($total_items)); ?></strong></p>
		<?php endif; ?>

		<table class="wp-list-table widefat fixed striped">
			<thead>
				<tr>
					<th style="width: 30px;"><input type="checkbox" id="select-all-logs" /></th>
					<th style="width: 150px;">Timestamp</th>
					<th style="width: 120px;">Event</th>
					<th>Parameters</th>
					<th style="width: 100px;">Response</th>
					<?php if ($is_debug): ?>
						<th style="width: 150px;">Debug Info</th>
					<?php endif; ?>
					<th style="width: 80px;">Actions</th>
				</tr>
			</thead>
			<tbody id="logs-tbody">
				<?php if (empty($logs)): ?>
					<tr>
						<td colspan="<?php echo esc_attr($is_debug ? '7' : '6'); ?>"><?php echo esc_html__('No events logged yet.', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?></td>
					</tr>
				<?php else: ?>
					<?php foreach ($logs as $log): ?>
						<tr data-log-id="<?php echo esc_attr($log->id); ?>">
							<td><input type="checkbox" class="log-checkbox" value="<?php echo esc_attr($log->id); ?>" /></td>
							<td><?php echo esc_html($log->timestamp); ?></td>
							<td><strong><?php echo esc_html($log->event_name); ?></strong></td>
							<td>
								<div style="max-height: 100px; overflow-y: auto;">
									<code style="font-size: 11px;">
										<?php
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$params = json_decode($log->event_params, true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										echo esc_html(json_encode($params, JSON_PRETTY_PRINT));
										?>
									</code>
								</div>
							</td>
							<td>
								<?php if ($log->response_code): ?>
									<span class="<?php echo esc_attr($log->response_code == '200' ? 'dashicons dashicons-yes' : 'dashicons dashicons-no'); ?>"></span>
									<?php echo esc_html($log->response_code); ?>
								<?php else: ?>
									<span class="dashicons dashicons-minus"></span>
								<?php endif; ?>
							</td>
							<?php if ($is_debug && !empty($log->debug_info)): ?>
								<td>
									<div style="max-height: 100px; overflow-y: auto;">
										<code style="font-size: 10px;">
											<?php
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$debug = json_decode($log->debug_info, true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											if ($debug) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												echo esc_html(json_encode($debug, JSON_PRETTY_PRINT));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											} else {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												echo esc_html($log->debug_info);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											}
											?>
										</code>
									</div>
								</td>
							<?php elseif ($is_debug): ?>
								<td>-</td>
							<?php endif; ?>
							<td>
								<button class="button button-small delete-single-log" data-log-id="<?php echo esc_attr($log->id); ?>">
									<?php echo esc_html__('Delete', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'); ?>
								</button>
							</td>
						</tr>
					<?php endforeach; ?>
				<?php endif; ?>
			</tbody>
		</table>

		<?php if ($total_pages > 1): ?>
			<div class="tablenav">
				<div class="tablenav-pages">
					<?php
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$pagination = paginate_links([
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'base' => add_query_arg('paged', '%#%'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'format' => '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'prev_text' => __('&laquo; Previous', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'next_text' => __('Next &raquo;', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'total' => $total_pages,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'current' => $page,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'type' => 'plain',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'show_all' => false,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'end_size' => 1,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'mid_size' => 2
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									]);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if ($pagination) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										echo '<span class="displaying-num">' .
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											esc_html(sprintf(
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												/* translators: %s: Number of items */
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												_n('%s item', '%s items', $total_items, 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												number_format_i18n($total_items)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											)) .
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'</span>';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										echo wp_kses_post($pagination);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
					?>
				</div>
			</div>
		<?php endif; ?>
	</div>

	<hr style="margin-top: 50px;">
	<p style="text-align: center; color: #666; font-size: 12px; margin-top: 20px;">
		<?php echo wp_kses_post(sprintf(
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									/* translators: 1: Plugin version, 2: Author name */
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									esc_html__('GA4 Server-Side Tracking for WooCommerce v%1$s | Created by %2$s', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'1.1.0',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'<a href="https://iodata.work" target="_blank" style="text-decoration: none;">IO Data</a>'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								)); ?>
	</p>
<?php
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function ajax_clear_logs()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								check_ajax_referer('ga4_s2s_logs', 'nonce');

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!current_user_can('manage_options')) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_die();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Delete all log posts
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$args = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'post_type' => $this->log_post_type,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'post_status' => 'private',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'posts_per_page' => -1,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'fields' => 'ids'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$query = new WP_Query($args);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($query->have_posts()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									foreach ($query->posts as $post_id) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										wp_delete_post($post_id, true); // Force delete
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								wp_send_json_success();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function ajax_delete_logs()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								check_ajax_referer('ga4_s2s_logs', 'nonce');

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!current_user_can('manage_options')) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_die();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$logs_to_delete = isset($_POST['logs']) && is_array($_POST['logs']) ? array_map('intval', $_POST['logs']) : [];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (empty($logs_to_delete)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_send_json_error('No logs selected for deletion');
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									return;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$deleted_count = 0;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								foreach ($logs_to_delete as $log_id) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									// Verify this is actually our log post type
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (get_post_type($log_id) === $this->log_post_type) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (wp_delete_post($log_id, true)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$deleted_count++;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								wp_send_json_success(['deleted' => $deleted_count]);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function ajax_get_logs()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								check_ajax_referer('ga4_s2s_logs', 'nonce');

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!current_user_can('manage_options')) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_die();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get latest logs
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$args = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'post_type' => $this->log_post_type,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'post_status' => 'private',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'posts_per_page' => 50,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'orderby' => 'date',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'order' => 'DESC'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$query = new WP_Query($args);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$logs = [];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($query->have_posts()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									while ($query->have_posts()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$query->the_post();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$post_id = get_the_ID();

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log = new stdClass();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->id = $post_id;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->timestamp = get_post_meta($post_id, '_ga4_timestamp', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->event_name = get_post_meta($post_id, '_ga4_event_name', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->event_params = get_post_meta($post_id, '_ga4_event_params', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->response_code = get_post_meta($post_id, '_ga4_response_code', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->response_body = get_post_meta($post_id, '_ga4_response_body', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$log->debug_info = get_post_meta($post_id, '_ga4_debug_info', true);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$logs[] = $log;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_reset_postdata();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								wp_send_json_success($logs);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function ajax_send_test_event()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								check_ajax_referer('ga4_s2s_test', 'nonce');

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!current_user_can('manage_options')) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_die();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$platform = isset($_POST['platform']) ? sanitize_text_field(wp_unslash($_POST['platform'])) : 'both';

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$test_params = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'test_parameter' => 'test_value',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'timestamp' => current_time('mysql'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'source' => 'WordPress Admin Test',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'value' => 10.00,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'currency' => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'items' => [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										[
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'item_id' => 'TEST_PRODUCT_123',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'item_name' => 'Test Product',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'quantity' => 1,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'price' => 10.00
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										]
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									]
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$options = get_option($this->options_name, []);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$messages = [];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($platform === 'ga4' || $platform === 'both') {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (!empty($options['enable_ga4'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$this->send_ga4_event('test_event', $test_params);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$messages[] = 'GA4 test event sent';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($platform === 'facebook' || $platform === 'both') {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (!empty($options['enable_facebook'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$this->send_facebook_event('test_event', $test_params);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$messages[] = 'Facebook test event sent';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (empty($messages)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_send_json_error(__('No platforms are enabled for testing.', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel'));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								} else {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_send_json_success([
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'message' => implode('. ', $messages) . '. ' . __('Check the Event Logs to verify.', 'server-side-tracking-for-woocommerce-with-ga4-and-meta-pixel')
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									]);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private function get_currency()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$options = get_option($this->options_name, []);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($options['override_currency'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									return $options['target_currency'] ?? 'USD';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								return get_woocommerce_currency();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private function convert_price($price)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$options = get_option($this->options_name, []);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($options['override_currency']) && !empty($options['exchange_rate'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									return round((float)$price * (float)$options['exchange_rate'], 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								return round((float)$price, 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private function get_transaction_id($order_id = null)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// If we have an order ID, use it
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($order_id) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									return (string)$order_id;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// For cart/checkout events, use session-based transaction ID
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!session_id()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									@session_start();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Check if we already have a transaction ID for this session
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!isset($_SESSION['ga4_transaction_id'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									// Generate a unique transaction ID for this session
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$_SESSION['ga4_transaction_id'] = 'temp_' . uniqid() . '_' . time();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								return sanitize_text_field($_SESSION['ga4_transaction_id']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private function clear_session_transaction_id()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!session_id()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									@session_start();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								unset($_SESSION['ga4_transaction_id']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private function get_ga_client_id()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Try to get client ID from GA4 cookie
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($_COOKIE['_ga'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$ga_cookie = sanitize_text_field(wp_unslash($_COOKIE['_ga']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$ga_parts = explode('.', $ga_cookie);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (count($ga_parts) >= 4) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										return $ga_parts[2] . '.' . $ga_parts[3];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Try to get from session if previously stored
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!session_id()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									@session_start();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($_SESSION['ga4_client_id'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									return sanitize_text_field($_SESSION['ga4_client_id']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Generate a new client ID and store in session
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$client_id = time() . '.' . wp_rand(1000000000, 9999999999);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$_SESSION['ga4_client_id'] = $client_id;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								return $client_id;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private function get_ga_session_data()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$session_data = [];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get session number and timestamp from GA4 session cookie
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$options = get_option($this->options_name, []);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$measurement_id = $options['measurement_id'] ?? '';

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($measurement_id) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$session_cookie_name = '_ga_' . str_replace('G-', '', $measurement_id);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (isset($_COOKIE[$session_cookie_name])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										// Parse session cookie: GS1.1.1234567890.1.1.1234567890.0.0.0
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$cookie_value = sanitize_text_field(wp_unslash($_COOKIE[$session_cookie_name]));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$parts = explode('.', $cookie_value);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (count($parts) >= 6) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$session_data['session_number'] = $parts[3];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$session_data['session_start'] = $parts[2];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								return $session_data;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private function log_event($event_name, $params, $response, $debug_data = [])
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$options = get_option($this->options_name, []);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (empty($options['enable_logging'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									return;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$response_code = '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$response_body = '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$debug_info = null;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!is_wp_error($response)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$response_code = wp_remote_retrieve_response_code($response);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$response_body = wp_remote_retrieve_body($response);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								} else {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$response_body = $response->get_error_message();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($options['debug_mode'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$debug_info = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'request_url' => $debug_data['url'] ?? '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'request_headers' => $debug_data['headers'] ?? [],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'request_body' => $debug_data['body'] ?? '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'response_headers' => !is_wp_error($response) ? wp_remote_retrieve_headers($response)->getAll() : [],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'response_body_raw' => $response_body,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'client_id' => $debug_data['client_id'] ?? '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'user_id' => $debug_data['user_id'] ?? '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'php_memory_usage' => memory_get_usage(true) . ' bytes',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'execution_time' => $debug_data['execution_time'] ?? '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'wp_user' => wp_get_current_user()->user_login ?? 'guest'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Create log entry as custom post
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$post_data = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'post_type' => $this->log_post_type,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'post_title' => $event_name . ' - ' . current_time('mysql'),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'post_content' => json_encode($params),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'post_status' => 'private',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'meta_input' => [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'_ga4_event_name' => $event_name,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'_ga4_event_params' => json_encode($params),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'_ga4_response_code' => $response_code,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'_ga4_response_body' => $response_body,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'_ga4_debug_info' => $debug_info ? json_encode($debug_info) : '',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										'_ga4_timestamp' => current_time('mysql')
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									]
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								wp_insert_post($post_data);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private function send_event($event_name, $params = [], $user_id = null, $client_id = null)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$options = get_option($this->options_name, []);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Send to GA4 if enabled
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($options['enable_ga4']) && $options['enable_ga4'] === '1') {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$this->send_ga4_event($event_name, $params, $user_id, $client_id);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Send to Facebook if enabled
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($options['enable_facebook']) && $options['enable_facebook'] === '1') {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$this->send_facebook_event($event_name, $params, $user_id);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private function send_ga4_event($event_name, $params = [], $user_id = null, $client_id = null)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$options = get_option($this->options_name, []);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$measurement_id = isset($options['measurement_id']) ? $options['measurement_id'] : '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$api_secret = isset($options['api_secret']) ? $options['api_secret'] : '';

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!$measurement_id || !$api_secret) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (!empty($options['debug_mode'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$this->log_event('ga4_' . $event_name, $params, new WP_Error('missing_credentials', 'Missing GA4 credentials'), [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'error' => 'Missing measurement_id or api_secret'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										]);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									return;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get client_id from GA4 cookie or generate one
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!$client_id) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$client_id = $this->get_ga_client_id();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get user_id if not provided but user is logged in
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!$user_id && is_user_logged_in()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$user_id = get_current_user_id();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Add user properties to params if user is logged in
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($user_id) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$user = get_user_by('ID', $user_id);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if ($user) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$params['user_properties'] = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'user_email' => $user->user_email,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'user_role' => implode(',', $user->roles),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'user_registered' => $user->user_registered,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'user_display_name' => $user->display_name
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										// Add WooCommerce customer data if available
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (class_exists('WC_Customer')) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$customer = new WC_Customer($user_id);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$params['user_properties']['total_spent'] = round($customer->get_total_spent(), 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$params['user_properties']['order_count'] = $customer->get_order_count();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$params['user_properties']['billing_country'] = $customer->get_billing_country();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Add GA4 session data
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$session_data = $this->get_ga_session_data();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($session_data)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$params['session_number'] = $session_data['session_number'] ?? null;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$params['session_start'] = $session_data['session_start'] ?? null;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Add engagement time (placeholder - you can calculate actual engagement)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params['engagement_time_msec'] = 100;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Add page location and referrer
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($_SERVER['HTTP_REFERER'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$params['page_referrer'] = esc_url_raw(wp_unslash($_SERVER['HTTP_REFERER']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Build page location with proper sanitization
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$protocol = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on') ? 'https' : 'http';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$host = isset($_SERVER['HTTP_HOST']) ? sanitize_text_field(wp_unslash($_SERVER['HTTP_HOST'])) : '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$uri = isset($_SERVER['REQUEST_URI']) ? sanitize_text_field(wp_unslash($_SERVER['REQUEST_URI'])) : '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params['page_location'] = esc_url_raw($protocol . '://' . $host . $uri);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Add user agent data
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($_SERVER['HTTP_USER_AGENT'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$params['user_agent'] = sanitize_text_field(wp_unslash($_SERVER['HTTP_USER_AGENT']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$payload = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"client_id" => $client_id,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"events"  => [[
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"name"  => $event_name,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"params" => $params
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									]]
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($user_id) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$payload["user_id"] = (string)$user_id;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$url = "https://www.google-analytics.com/mp/collect?measurement_id={$measurement_id}&api_secret={$api_secret}";
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$headers = ['Content-Type' => 'application/json'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$body = wp_json_encode($payload);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$start_time = microtime(true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$response = wp_remote_post($url, [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'body'  => $body,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'headers' => $headers,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'timeout' => 10
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								]);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$execution_time = round((microtime(true) - $start_time) * 1000, 2) . 'ms';

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$debug_data = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'url' => $url,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'headers' => $headers,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'body' => $body,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'client_id' => $client_id,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'user_id' => $user_id,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'execution_time' => $execution_time
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->log_event('ga4_' . $event_name, $params, $response, $debug_data);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private function send_facebook_event($event_name, $params = [], $user_id = null)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$options = get_option($this->options_name, []);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$pixel_id = isset($options['fb_pixel_id']) ? $options['fb_pixel_id'] : '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$access_token = isset($options['fb_access_token']) ? $options['fb_access_token'] : '';

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!$pixel_id || !$access_token) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (!empty($options['debug_mode'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$this->log_event('fb_' . $event_name, $params, new WP_Error('missing_credentials', 'Missing Facebook Pixel credentials'), [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'error' => 'Missing pixel_id or access_token'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										]);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									return;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Map WooCommerce event names to Facebook event names
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$fb_event_map = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'view_item' => 'ViewContent',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'view_cart' => 'ViewContent',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'add_to_cart' => 'AddToCart',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'remove_from_cart' => 'RemoveFromCart',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'begin_checkout' => 'InitiateCheckout',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'add_shipping_info' => 'AddShippingInfo',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'add_payment_info' => 'AddPaymentInfo',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'purchase' => 'Purchase',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'payment_failed' => 'PaymentFailed',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'refund' => 'Refund'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$fb_event_name = isset($fb_event_map[$event_name]) ? $fb_event_map[$event_name] : $event_name;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get user data
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$user_data = [];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get client IP
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$client_ip = $this->get_client_ip();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($client_ip) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$user_data['client_ip_address'] = $client_ip;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get user agent
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($_SERVER['HTTP_USER_AGENT'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$user_data['client_user_agent'] = sanitize_text_field(wp_unslash($_SERVER['HTTP_USER_AGENT']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get user email and data if available
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($user_id) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$user = get_user_by('ID', $user_id);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if ($user) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$user_data['em'] = hash('sha256', strtolower($user->user_email));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$user_data['fn'] = hash('sha256', strtolower($user->first_name));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$user_data['ln'] = hash('sha256', strtolower($user->last_name));

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										// Get phone number from user meta (billing phone)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$phone = get_user_meta($user_id, 'billing_phone', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if ($phone) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											// Remove all non-numeric characters and hash
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$phone_clean = preg_replace('/[^0-9]/', '', $phone);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											if ($phone_clean) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['ph'] = hash('sha256', $phone_clean);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										// Get billing city and state/country for better matching
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$city = get_user_meta($user_id, 'billing_city', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if ($city) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$user_data['ct'] = hash('sha256', strtolower($city));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$state = get_user_meta($user_id, 'billing_state', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if ($state) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$user_data['st'] = hash('sha256', strtolower($state));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$postcode = get_user_meta($user_id, 'billing_postcode', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if ($postcode) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$user_data['zp'] = hash('sha256', strtolower(str_replace(' ', '', $postcode)));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$country = get_user_meta($user_id, 'billing_country', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if ($country) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$user_data['country'] = hash('sha256', strtolower($country));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								} elseif (is_user_logged_in()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$current_user = wp_get_current_user();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$user_data['em'] = hash('sha256', strtolower($current_user->user_email));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$user_data['fn'] = hash('sha256', strtolower($current_user->first_name));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$user_data['ln'] = hash('sha256', strtolower($current_user->last_name));

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									// Get phone and address data for logged in user
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$user_id = $current_user->ID;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$phone = get_user_meta($user_id, 'billing_phone', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if ($phone) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$phone_clean = preg_replace('/[^0-9]/', '', $phone);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if ($phone_clean) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$user_data['ph'] = hash('sha256', $phone_clean);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$city = get_user_meta($user_id, 'billing_city', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if ($city) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$user_data['ct'] = hash('sha256', strtolower($city));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$state = get_user_meta($user_id, 'billing_state', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if ($state) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$user_data['st'] = hash('sha256', strtolower($state));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$postcode = get_user_meta($user_id, 'billing_postcode', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if ($postcode) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$user_data['zp'] = hash('sha256', strtolower(str_replace(' ', '', $postcode)));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$country = get_user_meta($user_id, 'billing_country', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if ($country) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$user_data['country'] = hash('sha256', strtolower($country));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Also try to get data from WooCommerce session for guest users
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (function_exists('WC') && WC()->session) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$customer = WC()->session->get('customer');
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if ($customer && is_array($customer)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										// Get email if not already set
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (empty($user_data['em']) && !empty($customer['email'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$user_data['em'] = hash('sha256', strtolower($customer['email']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										// Get billing phone if not already set
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (empty($user_data['ph']) && !empty($customer['billing_phone'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$phone_clean = preg_replace('/[^0-9]/', '', $customer['billing_phone']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											if ($phone_clean) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['ph'] = hash('sha256', $phone_clean);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										} elseif (empty($user_data['ph']) && !empty($customer['phone'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$phone_clean = preg_replace('/[^0-9]/', '', $customer['phone']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											if ($phone_clean) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['ph'] = hash('sha256', $phone_clean);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										// Get first name if not already set
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (empty($user_data['fn'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											if (!empty($customer['billing_first_name'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['fn'] = hash('sha256', strtolower($customer['billing_first_name']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											} elseif (!empty($customer['first_name'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['fn'] = hash('sha256', strtolower($customer['first_name']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										// Get last name if not already set
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (empty($user_data['ln'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											if (!empty($customer['billing_last_name'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['ln'] = hash('sha256', strtolower($customer['billing_last_name']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											} elseif (!empty($customer['last_name'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['ln'] = hash('sha256', strtolower($customer['last_name']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										// Get location data - try billing fields first
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (empty($user_data['ct'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											if (!empty($customer['billing_city'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['ct'] = hash('sha256', strtolower($customer['billing_city']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											} elseif (!empty($customer['city'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['ct'] = hash('sha256', strtolower($customer['city']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (empty($user_data['st'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											if (!empty($customer['billing_state'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['st'] = hash('sha256', strtolower($customer['billing_state']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											} elseif (!empty($customer['state'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['st'] = hash('sha256', strtolower($customer['state']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (empty($user_data['zp'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											if (!empty($customer['billing_postcode'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['zp'] = hash('sha256', strtolower(str_replace(' ', '', $customer['billing_postcode'])));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											} elseif (!empty($customer['postcode'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['zp'] = hash('sha256', strtolower(str_replace(' ', '', $customer['postcode'])));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (empty($user_data['country'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											if (!empty($customer['billing_country'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['country'] = hash('sha256', strtolower($customer['billing_country']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											} elseif (!empty($customer['country'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$user_data['country'] = hash('sha256', strtolower($customer['country']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get FBC (Facebook Click ID) from cookie
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($_COOKIE['_fbc'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$user_data['fbc'] = sanitize_text_field(wp_unslash($_COOKIE['_fbc']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get FBP (Facebook Browser ID) from cookie
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($_COOKIE['_fbp'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$user_data['fbp'] = sanitize_text_field(wp_unslash($_COOKIE['_fbp']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Convert custom data based on event type
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$custom_data = [];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($params['currency'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$custom_data['currency'] = $params['currency'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($params['value'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$custom_data['value'] = (string)$params['value'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Handle items/products
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($params['items']) && is_array($params['items'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$contents = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$content_ids = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$num_items = 0;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									foreach ($params['items'] as $item) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$content_ids[] = $item['item_id'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$contents[] = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'id' => $item['item_id'],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'quantity' => isset($item['quantity']) ? (int)$item['quantity'] : 1,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											'item_price' => isset($item['price']) ? (float)$item['price'] : 0
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$num_items += isset($item['quantity']) ? (int)$item['quantity'] : 1;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$custom_data['content_ids'] = $content_ids;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$custom_data['contents'] = $contents;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$custom_data['content_type'] = 'product';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$custom_data['num_items'] = $num_items;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Add order/transaction ID
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($params['transaction_id'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$custom_data['order_id'] = $params['transaction_id'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Build the event data
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$event_data = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'event_name' => $fb_event_name,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'event_time' => time(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'event_source_url' => home_url(sanitize_text_field(wp_unslash($_SERVER['REQUEST_URI'] ?? ''))),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'user_data' => $user_data,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'custom_data' => $custom_data,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'action_source' => 'website'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Add event ID for deduplication
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$event_data['event_id'] = uniqid($fb_event_name . '_', true);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get test event code if available
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$test_event_code = isset($options['fb_test_event_code']) ? trim($options['fb_test_event_code']) : '';

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Prepare the API request
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$url = "https://graph.facebook.com/v20.0/{$pixel_id}/events";

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$payload = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'data' => [$event_data],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'access_token' => $access_token
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Add test event code at root level only (not in event data)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($test_event_code) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$payload['test_event_code'] = $test_event_code;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$headers = ['Content-Type' => 'application/json'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$body = wp_json_encode($payload);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$start_time = microtime(true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$response = wp_remote_post($url, [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'body'  => $body,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'headers' => $headers,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'timeout' => 10
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								]);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$execution_time = round((microtime(true) - $start_time) * 1000, 2) . 'ms';

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$debug_data = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'url' => $url,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'headers' => $headers,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'body' => $body,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'event_name' => $fb_event_name,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'execution_time' => $execution_time
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->log_event('fb_' . $event_name, $params, $response, $debug_data);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							private function get_client_ip()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$ip_keys = ['HTTP_CF_CONNECTING_IP', 'HTTP_CLIENT_IP', 'HTTP_X_FORWARDED_FOR', 'REMOTE_ADDR'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								foreach ($ip_keys as $key) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (array_key_exists($key, $_SERVER) === true) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$ip = sanitize_text_field(wp_unslash($_SERVER[$key]));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										// For Facebook, we send any valid IP (including private ones)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										// Facebook will handle the IP appropriately
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (filter_var($ip, FILTER_VALIDATE_IP)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											// If it's from a proxy header and contains multiple IPs, get the first one
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											if (strpos($ip, ',') !== false) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$ips = explode(',', $ip);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												$ip = trim($ips[0]);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											return $ip;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								return isset($_SERVER['REMOTE_ADDR']) ? sanitize_text_field(wp_unslash($_SERVER['REMOTE_ADDR'])) : '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function track_view_item()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								global $product;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!$product) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"currency" => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"value" => $this->convert_price($product->get_price()),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"items" => [[
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_id"  => (string)$product->get_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_name" => $product->get_name(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"price"   => $this->convert_price($product->get_price()),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"quantity" => 1
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									]]
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->send_event("view_item", $params);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function track_view_cart()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!WC()->cart || WC()->cart->is_empty()) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Prevent duplicate tracking on same page load
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								static $tracked = false;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($tracked) return;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$tracked = true;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$items = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$total_value = 0;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								foreach (WC()->cart->get_cart() as $cart_item) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$product = $cart_item['data'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$price = $this->convert_price($product->get_price());
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$item_total = round($price * $cart_item['quantity'], 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$total_value += $item_total;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$items[] = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_id"  => (string)$product->get_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_name" => $product->get_name(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"quantity" => (int)$cart_item['quantity'],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"price"   => $price
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"transaction_id" => $this->get_transaction_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"currency" => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"value"  => round($total_value, 2),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"items"  => $items
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->send_event("view_cart", $params);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function track_add_to_cart($cart_item_key, $product_id, $quantity, $variation_id, $variation, $cart_item_data)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$product = wc_get_product($variation_id ?: $product_id);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!$product) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$price = $this->convert_price($product->get_price());
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"transaction_id" => $this->get_transaction_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"currency" => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"value"  => round($price * $quantity, 2),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"items"  => [[
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_id"  => (string)$product->get_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_name" => $product->get_name(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"quantity" => (int)$quantity,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"price"   => $price
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									]]
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->send_event("add_to_cart", $params);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function track_remove_from_cart($cart_item_key, $cart)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!isset($cart->removed_cart_contents[$cart_item_key])) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$item = $cart->removed_cart_contents[$cart_item_key];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$product = $item['data'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!$product) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$price = $this->convert_price($product->get_price());
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"transaction_id" => $this->get_transaction_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"currency" => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"value"  => round($price * $item['quantity'], 2),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"items"  => [[
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_id"  => (string)$product->get_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_name" => $product->get_name(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"quantity" => (int)$item['quantity'],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"price"   => $price
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									]]
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->send_event("remove_from_cart", $params);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function track_begin_checkout()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!WC()->cart) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$items = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$total_value = 0;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								foreach (WC()->cart->get_cart() as $cart_item) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$product = $cart_item['data'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$price = $this->convert_price($product->get_price());
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$item_total = round($price * $cart_item['quantity'], 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$total_value += $item_total;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$items[] = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_id"  => (string)$product->get_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_name" => $product->get_name(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"quantity" => (int)$cart_item['quantity'],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"price"   => $price
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"transaction_id" => $this->get_transaction_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"currency" => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"value"  => round($total_value, 2),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"items"  => $items
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->send_event("begin_checkout", $params);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function track_add_shipping_info($post_data)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Parse the posted data
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								parse_str($post_data, $posted);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!WC()->cart || WC()->cart->is_empty()) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get selected shipping method
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$chosen_methods = WC()->session->get('chosen_shipping_methods');
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$shipping_method = !empty($chosen_methods[0]) ? $chosen_methods[0] : '';

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!$shipping_method) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Prevent duplicate tracking in same session
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!session_id()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									@session_start();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$session_key = 'ga4_shipping_info_' . $shipping_method;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$transaction_id = $this->get_transaction_id();

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($_SESSION[$session_key]) && sanitize_text_field($_SESSION[$session_key]) === $transaction_id) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									return;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$items = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$total_value = 0;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								foreach (WC()->cart->get_cart() as $cart_item) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$product = $cart_item['data'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$price = $this->convert_price($product->get_price());
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$item_total = round($price * $cart_item['quantity'], 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$total_value += $item_total;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$items[] = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_id"  => (string)$product->get_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_name" => $product->get_name(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"quantity" => (int)$cart_item['quantity'],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"price"   => $price
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get shipping data
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$shipping_total = WC()->cart->get_shipping_total();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$shipping_tax = WC()->cart->get_shipping_tax();

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get shipping method details
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$packages = WC()->shipping()->get_packages();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$shipping_method_title = '';

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($packages)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									foreach ($packages as $package) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (isset($package['rates'][$shipping_method])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$shipping_method_title = $package['rates'][$shipping_method]->get_label();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											break;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get shipping address data if available
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$shipping_data = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'shipping_tier' => $shipping_method_title ?: $shipping_method,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'shipping_cost' => $this->convert_price($shipping_total),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'shipping_tax' => $this->convert_price($shipping_tax)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Add address info if available
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($posted['shipping_country'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$shipping_data['shipping_country'] = sanitize_text_field($posted['shipping_country']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($posted['shipping_state'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$shipping_data['shipping_state'] = sanitize_text_field($posted['shipping_state']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($posted['shipping_city'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$shipping_data['shipping_city'] = sanitize_text_field($posted['shipping_city']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($posted['shipping_postcode'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$shipping_data['shipping_postcode'] = sanitize_text_field($posted['shipping_postcode']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params = array_merge([
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"transaction_id" => $transaction_id,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"currency" => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"value" => round($total_value + $this->convert_price($shipping_total), 2),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"shipping_tier" => $shipping_method_title ?: $shipping_method,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"items" => $items
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								], $shipping_data);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$_SESSION[$session_key] = $transaction_id;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->send_event("add_shipping_info", $params);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function ajax_track_shipping_method()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Track shipping method selection via AJAX
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								check_ajax_referer('update-shipping-method', 'security');

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!WC()->cart || WC()->cart->is_empty()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_die();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$shipping_method = '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($_POST['shipping_method']) && is_array($_POST['shipping_method'])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									// Sanitize the entire array first
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$shipping_methods = array_map('sanitize_text_field', wp_unslash($_POST['shipping_method']));
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (isset($shipping_methods[0])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										$shipping_method = wc_clean($shipping_methods[0]);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!$shipping_method) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_die();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$items = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$total_value = 0;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								foreach (WC()->cart->get_cart() as $cart_item) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$product = $cart_item['data'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$price = $this->convert_price($product->get_price());
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$item_total = round($price * $cart_item['quantity'], 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$total_value += $item_total;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$items[] = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_id"  => (string)$product->get_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_name" => $product->get_name(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"quantity" => (int)$cart_item['quantity'],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"price"   => $price
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Get shipping details
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$packages = WC()->shipping()->get_packages();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$shipping_method_title = '';
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$shipping_cost = 0;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($packages)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									foreach ($packages as $package) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										if (isset($package['rates'][$shipping_method])) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$shipping_method_title = $package['rates'][$shipping_method]->get_label();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											$shipping_cost = $package['rates'][$shipping_method]->get_cost();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											break;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"transaction_id" => $this->get_transaction_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"currency" => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"value" => round($total_value + $this->convert_price($shipping_cost), 2),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"shipping_tier" => $shipping_method_title ?: $shipping_method,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"shipping_cost" => $this->convert_price($shipping_cost),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"items" => $items
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->send_event("add_shipping_info", $params);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								wp_send_json_success(['tracked' => true]);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function track_add_payment_info($data, $errors)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Track when payment info is added during checkout validation
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!WC()->cart || WC()->cart->is_empty() || $errors->get_error_messages()) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$items = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$total_value = 0;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								foreach (WC()->cart->get_cart() as $cart_item) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$product = $cart_item['data'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$price = $this->convert_price($product->get_price());
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$item_total = round($price * $cart_item['quantity'], 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$total_value += $item_total;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$items[] = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_id"  => (string)$product->get_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_name" => $product->get_name(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"quantity" => (int)$cart_item['quantity'],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"price"   => $price
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$payment_method = isset($data['payment_method']) ? $data['payment_method'] : 'unknown';

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"transaction_id" => $this->get_transaction_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"currency" => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"value"  => round($total_value, 2),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"payment_type" => $payment_method,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"items"  => $items
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Prevent duplicate tracking in same session
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!session_id()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									@session_start();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$session_key = 'ga4_payment_info_' . $payment_method;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (isset($_SESSION[$session_key]) && sanitize_text_field($_SESSION[$session_key]) === $this->get_transaction_id()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									return;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$_SESSION[$session_key] = $this->get_transaction_id();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->send_event("add_payment_info", $params);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function ajax_track_payment_method()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Track payment method selection via AJAX (for dynamic checkout)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								check_ajax_referer('woocommerce-process_checkout', 'security');

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!WC()->cart || WC()->cart->is_empty()) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									wp_die();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$payment_method = isset($_POST['payment_method']) ? sanitize_text_field(wp_unslash($_POST['payment_method'])) : 'unknown';

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$items = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$total_value = 0;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								foreach (WC()->cart->get_cart() as $cart_item) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$product = $cart_item['data'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$price = $this->convert_price($product->get_price());
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$item_total = round($price * $cart_item['quantity'], 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$total_value += $item_total;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$items[] = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_id"  => (string)$product->get_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_name" => $product->get_name(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"quantity" => (int)$cart_item['quantity'],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"price"   => $price
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"transaction_id" => $this->get_transaction_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"currency" => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"value"  => round($total_value, 2),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"payment_type" => $payment_method,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"items"  => $items
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->send_event("add_payment_info", $params);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								wp_send_json_success(['tracked' => true]);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function enqueue_checkout_tracking_script()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!is_checkout()) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$options = get_option($this->options_name, []);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$track_shipping = !empty($options['enabled_events']['add_shipping_info']);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$track_payment = !empty($options['enabled_events']['add_payment_info']);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$script = "
      jQuery(document).ready(function($) {
    ";

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($track_payment) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$script .= "
        var lastTrackedMethod = '';

        // Track payment method change
        $('body').on('change', 'input[name=\"payment_method\"]', function() {
          var method = $(this).val();
          if (method && method !== lastTrackedMethod) {
            lastTrackedMethod = method;

            $.ajax({
              url: '" . esc_url(admin_url('admin-ajax.php')) . "',
              type: 'POST',
              data: {
                action: 'track_payment_method',
                payment_method: method,
                security: $('#woocommerce-process-checkout-nonce').val() || wc_checkout_params.checkout_nonce
              }
            });
          }
        });

        // Trigger on page load if method is already selected
        setTimeout(function() {
          $('input[name=\"payment_method\"]:checked').trigger('change');
        }, 1000);
      ";
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if ($track_shipping) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$script .= "
        var lastTrackedShipping = '';

        // Track shipping method change
        $('body').on('change', 'input[name^=\"shipping_method\"]', function() {
          var method = $(this).val();
          if (method && method !== lastTrackedShipping) {
            lastTrackedShipping = method;

            $.ajax({
              url: '" . esc_url(admin_url('admin-ajax.php')) . "',
              type: 'POST',
              data: {
                action: 'track_shipping_method',
                shipping_method: [method],
                security: $('#woocommerce-shipping-calculator-nonce').val() ||
                     $('input[name=\"update-shipping-method-nonce\"]').val() ||
                     wc_checkout_params.update_order_review_nonce
              }
            });
          }
        });

        // Also track when shipping is updated via order review
        $(document.body).on('updated_checkout', function() {
          var checkedShipping = $('input[name^=\"shipping_method\"]:checked').val();
          if (!checkedShipping) {
            checkedShipping = $('input[name^=\"shipping_method\"][type=\"hidden\"]').val();
          }
          if (checkedShipping && checkedShipping !== lastTrackedShipping) {
            lastTrackedShipping = checkedShipping;

            $.ajax({
              url: '" . esc_url(admin_url('admin-ajax.php')) . "',
              type: 'POST',
              data: {
                action: 'track_shipping_method',
                shipping_method: [checkedShipping],
                security: wc_checkout_params.update_order_review_nonce
              }
            });
          }
        });
      ";
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$script .= "
      });
    ";

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								wp_add_inline_script('wc-checkout', $script);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function track_purchase($order_id)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$order = wc_get_order($order_id);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!$order) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (get_post_meta($order_id, '_ga4_purchase_tracked', true)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									return;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$items = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								foreach ($order->get_items() as $item) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$product = $item->get_product();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (!$product) continue;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$item_price = round($item->get_total() / $item->get_quantity(), 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$items[] = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_id"  => (string)$product->get_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_name" => $item->get_name(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"quantity" => (int)$item->get_quantity(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"price"   => $this->convert_price($item_price)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"transaction_id" => $this->get_transaction_id($order_id),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"currency"    => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"value"     => $this->convert_price($order->get_total()),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"tax"      => $this->convert_price($order->get_total_tax()),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"shipping"    => $this->convert_price($order->get_shipping_total()),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"items"     => $items
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$user_id = $order->get_customer_id();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->send_event("purchase", $params, $user_id ?: null);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								update_post_meta($order_id, '_ga4_purchase_tracked', true);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Clear session transaction ID after successful purchase
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->clear_session_transaction_id();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function track_payment_failed($order_id)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$order = wc_get_order($order_id);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!$order) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Prevent duplicate tracking
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (get_post_meta($order_id, '_ga4_payment_failed_tracked', true)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									return;
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$items = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								foreach ($order->get_items() as $item) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$product = $item->get_product();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (!$product) continue;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$item_price = round($item->get_total() / $item->get_quantity(), 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$items[] = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_id"  => (string)$product->get_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_name" => $item->get_name(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"quantity" => (int)$item->get_quantity(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"price"   => $this->convert_price($item_price)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"transaction_id" => $this->get_transaction_id($order_id),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"currency"    => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"value"     => $this->convert_price($order->get_total()),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"tax"      => $this->convert_price($order->get_total_tax()),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"shipping"    => $this->convert_price($order->get_shipping_total()),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"payment_type"  => $order->get_payment_method(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"items"     => $items
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Add failure reason if available
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$order_notes = wc_get_order_notes([
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'order_id' => $order_id,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'limit' => 1,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'orderby' => 'date_created',
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									'order' => 'DESC'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								]);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!empty($order_notes)) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$params['failure_reason'] = substr($order_notes[0]->content, 0, 100);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$user_id = $order->get_customer_id();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->send_event("payment_failed", $params, $user_id ?: null);

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								update_post_meta($order_id, '_ga4_payment_failed_tracked', true);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function track_payment_failed_checkout()
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Track payment failure during checkout (before order is created)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// This function is only called during WooCommerce payment processing
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								// Verify WooCommerce checkout nonce - required for security
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									!isset($_REQUEST['woocommerce-process-checkout-nonce']) ||
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									!wp_verify_nonce(sanitize_text_field(wp_unslash($_REQUEST['woocommerce-process-checkout-nonce'])), 'woocommerce-process_checkout')
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									// Also check for WooCommerce pay nonce (for payment page)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										!isset($_REQUEST['woocommerce-pay-nonce']) ||
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										!wp_verify_nonce(sanitize_text_field(wp_unslash($_REQUEST['woocommerce-pay-nonce'])), 'woocommerce-pay')
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										return; // No valid nonce found
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!WC()->cart || WC()->cart->is_empty()) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$items = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$total_value = 0;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								foreach (WC()->cart->get_cart() as $cart_item) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$product = $cart_item['data'];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$price = $this->convert_price($product->get_price());
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$item_total = round($price * $cart_item['quantity'], 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$total_value += $item_total;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$items[] = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_id"  => (string)$product->get_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_name" => $product->get_name(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"quantity" => (int)$cart_item['quantity'],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"price"   => $price
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"transaction_id" => $this->get_transaction_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"currency" => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"value"  => round($total_value, 2),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"items"  => $items,
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"payment_type" => isset($_POST['payment_method']) ? sanitize_text_field(wp_unslash($_POST['payment_method'])) : 'unknown'
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->send_event("payment_failed", $params);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							public function track_refund($order_id)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							{
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$order = wc_get_order($order_id);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								if (!$order) return;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$items = [];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								foreach ($order->get_items() as $item) {
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$product = $item->get_product();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									if (!$product) continue;

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$item_price = round($item->get_total() / $item->get_quantity(), 2);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									$items[] = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_id"  => (string)$product->get_id(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"item_name" => $item->get_name(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"quantity" => (int)$item->get_quantity(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																										"price"   => $this->convert_price($item_price)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									];
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$params = [
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"transaction_id" => $this->get_transaction_id($order_id),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"currency"    => $this->get_currency(),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"value"     => $this->convert_price($order->get_total()),
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									"items"     => $items
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								];

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$user_id = $order->get_customer_id();
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								$this->send_event("refund", $params, $user_id ?: null);
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							}
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						}

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						new GA4_S2S_Woo_Tracking();
